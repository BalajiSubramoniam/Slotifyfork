{% extends 'base.html' %}

{% block title %}{{ machine.name }} – Monthly Slot Calendar{% endblock %}

{% block content %}
<div class="calendar-container my-4">
    <h2 class="text-center mb-4 display-6">{{ machine.name }} – Booking Calendar<br>
        <small class="text-muted">{{ month }} {{ year }}</small>
    </h2>

    <div id="alert-placeholder"></div>

    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle calendar-table">
            <thead class="table-light">
                <tr>
                    <th scope="col" class="date-cell">Date</th>
                    {% for slot in calendar_data.values()|list|first %}
                    <th scope="col">
                        Slot {{ slot.slot_number }}<br>
                        <small>{{ slot.time_range }}</small>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for date, slots in calendar_data.items() %}
                <tr>
                    <td class="date-cell fw-bold">{{ moment(date).format('LL') }}</td>
                    {% for slot in slots %}
                    {% if slot.is_booked %}
                    {% if slot.booked_by['user_uuid'] == current_user.uuid %}
                    <td class="bg-danger text-white d-flex justify-content-center align-items-center gap-1 cancelable-slot"
                        data-slot-uuid="{{ slot.slot_uuid }}" data-date="{{ date }}"
                        title="Click to cancel your booking"
                        style="min-width: 140px; cursor: pointer; border: 1px solid #ccc; padding: 4px 6px;">
                        <img src="{{ slot.booked_by['avatar'] }}" alt="User Avatar" width="36" height="36"
                            class="rounded-circle" style="border:none; flex-shrink: 0;">
                        <span class="fw-semibold small ms-1">{{ slot.booked_by['username'] }}</span>
                    </td>
                    {% else %}
                    <td class="bg-danger text-white d-flex justify-content-center align-items-center gap-1"
                        style="min-width: 140px; border: 1px solid #ccc; padding: 4px 6px;">
                        <img src="{{ slot.booked_by['avatar'] }}" alt="User Avatar" width="36" height="36"
                            class="rounded-circle popover-trigger" tabindex="0" role="button" data-bs-toggle="popover"
                            data-bs-trigger="focus" data-bs-placement="top" title="{{ slot.booked_by['username'] }}"
                            data-bs-html="true" data-bs-content='
                        <div class="text-center">
                            <img src="{{ slot.booked_by["avatar"] }}" alt="Avatar" width="64" height="64" class="rounded-circle mb-2" style="border:1px solid #6c757d;">
                            <div><strong>{{ slot.booked_by["user"] }}</strong></div>
                            <div class="text-muted">{{ slot.booked_by["username"] }}</div>
                            <hr class="my-1">
                            <div><strong>Email:</strong> {{ slot.booked_by["email"] }}</div>
                            <div><strong>Contact No:</strong> {{ slot.booked_by["contact_no"] }}</div>
                            <div><strong>Building:</strong> {{ slot.booked_by["building"] }}</div>
                            <div><strong>Room No:</strong> {{ slot.booked_by["room_no"] }}</div>
                            <div><strong>Course:</strong> {{ slot.booked_by["course"] }}</div>
                        </div>'>
                        <span class="fw-semibold small ms-1">{{ slot.booked_by['username'] }}</span>
                    </td>
                    {% endif %}
                    {% else %}
                    <td class="bg-success text-white cursor-pointer available-slot" data-machine-id="{{ machine.id }}"
                        data-slot-number="{{ slot.slot_number }}" data-date="{{ date }}"
                        style="min-width: 140px; border: 1px solid #ccc; padding: 4px 6px;">

                        <!-- Invisible placeholder to keep size consistent -->
                        <span
                            style="visibility:hidden; display:flex; align-items:center; gap:4px; justify-content:center; min-width: 100px;">
                            <img src="https://via.placeholder.com/36" alt="placeholder" width="36" height="36"
                                class="rounded-circle" style="border:none;">
                            <span class="fw-semibold small">Username</span>
                        </span>
                    </td>
                    {% endif %}
                    {% endfor %}


                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Initialize Bootstrap popovers
        const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl);
        });

        // Check if user is logged in
        const userLoggedIn = {{ 'true' if current_user.is_authenticated else 'false' }};

        const alertPlaceholder = document.getElementById('alert-placeholder');

        function showAlert(message, type = 'success') {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            alertPlaceholder.append(wrapper);
        }

        // -------------------------------
        // Booking an available slot
        // -------------------------------
        document.querySelectorAll('.available-slot').forEach(td => {
            td.style.cursor = 'pointer';

            td.addEventListener('click', async () => {
                const machineId = td.dataset.machineId;
                const slotNumber = parseInt(td.dataset.slotNumber);
                const date = td.dataset.date;

                if (!userLoggedIn) {
                    showAlert(`Please log in to book Slot ${slotNumber} on ${date}.`, 'warning');
                    return;
                }

                const confirmBooking = confirm(`Do you want to book Slot ${slotNumber} on ${date}?`);
                if (!confirmBooking) return;

                td.style.pointerEvents = 'none';  // disable during request

                try {
                    const response = await fetch("{{ url_for('main.book_slot_route') }}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token() }}"
                        },
                        body: JSON.stringify({ machine_id: machineId, slot_number: slotNumber, date: date })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showAlert(data.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showAlert(data.message, 'danger');
                        td.style.pointerEvents = 'auto';
                    }
                } catch (error) {
                    showAlert('An error occurred. Please try again.', 'danger');
                    td.style.pointerEvents = 'auto';
                }
            });
        });

        // -------------------------------
        // Cancelling a booked slot
        // -------------------------------
        document.querySelectorAll('.cancelable-slot').forEach(td => {
            td.addEventListener('click', async () => {
                if (!confirm("Do you want to cancel this booking?")) return;

                const slotUuid = td.dataset.slotUuid;
                const date = td.dataset.date;

                td.style.pointerEvents = 'none';  // Disable during request

                try {
                    const response = await fetch("{{ url_for('main.cancel_slot_route') }}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token() }}"
                        },
                        body: JSON.stringify({ slot_uuid: slotUuid, date: date })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showAlert(data.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showAlert(data.message, 'danger');
                        td.style.pointerEvents = 'auto';
                    }
                } catch (error) {
                    showAlert('An error occurred. Please try again.', 'danger');
                    td.style.pointerEvents = 'auto';
                }
            });
        });

    }); // end of DOMContentLoaded
</script>

{% endblock %}